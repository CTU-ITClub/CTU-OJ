{% extends "base.html" %}

{% block media %}
    <style>
    </style>
{% endblock %}

{% block js_media %}
    <script>
        // This is basically impossible to write without ES6, hence separate script block.
        $(() => {
            {% include "user/webauthn-helpers.js" %}

            function buf2hex(buffer) {
                return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('');
            }

            $('#use-webauthn').click(event => {
                event.preventDefault();

                if (typeof window.PublicKeyCredential === 'undefined') {
                    _alert('{{ _('WebAuthn is not supported by your browser.') }}');
                    return;
                }

                $.getJSON('{{ url('webauthn_assert') }}')
                    .done(publicKey => {
                        decodeJSONBytes(publicKey);
                        navigator.credentials.get({publicKey})
                            .then(credential => {
                                credential = {
                                    id: credential.id,
                                    response: {
                                        authData: urlSafeBase64Encode(credential.response.authenticatorData),
                                        clientData: urlSafeBase64Encode(credential.response.clientDataJSON),
                                        signature: buf2hex(credential.response.signature),
                                    }
                                };
                                $('#id_webauthn_response').val(JSON.stringify(credential));
                                $('#2fa-form').submit();
                            });
                    })
                    .fail(() => _alert('{{ _('Failed to contact server.') }}'));
            })
        });
    </script>
{% endblock %}

{% block body %}
    <div class="ui container">
        <form action="" method="post" class="form-area ui form" id="2fa-form">
            {% csrf_token %}
            {% if form.errors %}
                <div id="form-errors" class="ui message red">
                    <p class="content">
                        {%- if form.errors['totp_token'] -%}
                            {{ ' '.join(form.errors['totp_token']) }}
                        {%- else -%}
                            {{ ' '.join(form.non_field_errors()) }}
                        {%- endif -%}
                    </p>
                </div>
            {% endif %}

            {% if request.profile.is_totp_enabled or request.profile.scratch_codes %}
                <div class="field">
                    <label>
                        {% if request.profile.is_totp_enabled %}
                            {{ _('Enter the 6-digit code generated by your app or one of your 16-character scratch codes:') }}
                        {% else %}
                            {{ _('Enter one of your 16-character scratch codes:') }}
                        {% endif %}
                    </label>
                </div>
                {{ form.totp_or_scratch_code }}
                <hr class="ui divider">
            {% endif %}
            {% if request.profile.is_webauthn_enabled %}
                {{ form.webauthn_response }}
                <button class="ui button" id="use-webauthn" type="button">{{ _('Use security key') }}</button>
            {% endif %}
            {% if request.profile.is_totp_enabled %}
                <button class="ui button primary" type="submit">{{ _('Login!') }}</button>
            {% elif request.profile.scratch_codes %}
                <button class="ui button" type="submit">{{ _('Use scratch code') }}</button>
            {% endif %}
        </form>
        {% if not is_hardcore and misc_config.discord_invite_link and misc_config.discord_invite_shieldio %}
            <p class="markdown-body">
                {{ _('If you lost your authentication device and are unable to use your scratch codes, feel free to shoot us a message at: ') }}
                <a href="{{ misc_config.discord_invite_link }}">
                    <img src="{{ misc_config.discord_invite_shieldio }}">
                </a>
            </p>
        {% endif %}
    </div>
{% endblock %}
